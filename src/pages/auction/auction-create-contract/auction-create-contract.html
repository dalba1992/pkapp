<ion-header>
  <ion-row class="header-row" (click)="goBack()">
    <ion-row class="header-title">
      <ion-col col-1>
        <ion-icon name="ios-arrow-back"></ion-icon>
      </ion-col>
      <span>
        Create Contract
      </span>
      <ion-col col-1>
      </ion-col>
    </ion-row>
  </ion-row>
  <div *ngIf="stepIndex === 1" class="step">
    <svg xmlns="http://www.w3.org/2000/svg" style="width: 100%" height="30.5" viewBox="0 0 317.754 30.5">
      <g id="Group_1104" data-name="Group 1104" transform="translate(-24.764 -99.5)">
        <g id="Ellipse_8" data-name="Ellipse 8" transform="translate(307 99.5) rotate(90)" fill="#8ADB20"
          stroke="rgba(255,255,255,0.2)" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <g id="Ellipse_10" data-name="Ellipse 10" transform="translate(194 99.5) rotate(90)" fill="#8ADB20"
          stroke="rgba(255,255,255,0.2)" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <g id="Ellipse_9" data-name="Ellipse 9" transform="translate(81 99.5) rotate(90)" fill="#8ADB20"
          stroke="#8ADB20" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <line id="Line_29" data-name="Line 29" x1="100" transform="translate(81.5 106)" fill="none"
          stroke="rgba(255,255,255,0.4)" stroke-linecap="round" stroke-width="1.5" stroke-dasharray="1 5" />
        <line id="Line_30" data-name="Line 30" x1="100" transform="translate(194.5 106)" fill="none"
          stroke="rgba(255,255,255,0.4)" stroke-linecap="round" stroke-width="1.5" stroke-dasharray="1 5" />
        <text id="Terms_Conditions" data-name="Terms &amp; Conditions" transform="translate(74.764 127)" fill="#8ADB20"
          font-size="10" font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-49.93" y="0">Terms &amp; Conditions</tspan>
        </text>
        <text id="Billing_info" data-name="Billing info" transform="translate(188 127)" fill="rgba(255,255,255,0.4)"
          font-size="10" font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-27.785" y="0">Billing info</tspan>
        </text>
        <text id="Payment_details" data-name="Payment details" transform="translate(300.518 127)"
          fill="rgba(255,255,255,0.4)" font-size="10" font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-41.92" y="0">Payment details</tspan>
        </text>
      </g>
    </svg>
  </div>

  <div *ngIf="stepIndex === 2" class="step">
    <svg xmlns="http://www.w3.org/2000/svg" style="width: 100%" height="30.5" viewBox="0 0 317.754 30.5">
      <g id="Group_1104" data-name="Group 1104" transform="translate(-24.764 -99.5)">
        <g id="Ellipse_8" data-name="Ellipse 8" transform="translate(307 99.5) rotate(90)" fill="#8ADB20"
          stroke="rgba(255,255,255,0.2)" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <g id="Ellipse_10" data-name="Ellipse 10" transform="translate(194 99.5) rotate(90)" fill="#8ADB20"
          stroke="#8ADB20" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <g id="Ellipse_9" data-name="Ellipse 9" transform="translate(81 99.5) rotate(90)" fill="#8ADB20"
          stroke="#8ADB20" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <line id="Line_29" data-name="Line 29" x1="100" transform="translate(81.5 106)" fill="none" stroke="#8ADB20"
          stroke-linecap="round" stroke-width="1.5" stroke-dasharray="1 5" />
        <line id="Line_30" data-name="Line 30" x1="100" transform="translate(194.5 106)" fill="none"
          stroke="rgba(255,255,255,0.4)" stroke-linecap="round" stroke-width="1.5" stroke-dasharray="1 5" />
        <text id="Terms_Conditions" data-name="Terms &amp; Conditions" transform="translate(74.764 127)" fill="#8ADB20"
          font-size="10" font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-49.93" y="0">Terms &amp; Conditions</tspan>
        </text>
        <text id="Billing_info" data-name="Billing info" transform="translate(188 127)" fill="#8ADB20" font-size="10"
          font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-27.785" y="0">Billing info</tspan>
        </text>
        <text id="Payment_details" data-name="Payment details" transform="translate(300.518 127)"
          fill="rgba(255,255,255,0.4)" font-size="10" font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-41.92" y="0">Payment details</tspan>
        </text>
      </g>
    </svg>

  </div>

  <div *ngIf="stepIndex === 3" class="step">
    <svg xmlns="http://www.w3.org/2000/svg" style="width: 100%" height="30.5" viewBox="0 0 317.754 30.5">
      <g id="Group_1105" data-name="Group 1105" transform="translate(-24.764 -99.5)">
        <g id="Ellipse_8" data-name="Ellipse 8" transform="translate(307 99.5) rotate(90)" fill="#8ADB20"
          stroke="#8ADB20" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <g id="Ellipse_10" data-name="Ellipse 10" transform="translate(194 99.5) rotate(90)" fill="#8ADB20"
          stroke="#8ADB20" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <g id="Ellipse_9" data-name="Ellipse 9" transform="translate(81 99.5) rotate(90)" fill="#8ADB20"
          stroke="#8ADB20" stroke-width="1.5">
          <circle cx="6.5" cy="6.5" r="6.5" stroke="none" />
          <circle cx="6.5" cy="6.5" r="5.75" fill="none" />
        </g>
        <line id="Line_29" data-name="Line 29" x1="100" transform="translate(81.5 106)" fill="none" stroke="#8ADB20"
          stroke-linecap="round" stroke-width="1.5" stroke-dasharray="1 5" />
        <line id="Line_30" data-name="Line 30" x1="100" transform="translate(194.5 106)" fill="none" stroke="#8ADB20"
          stroke-linecap="round" stroke-width="1.5" stroke-dasharray="1 5" />
        <text id="Terms_Conditions" data-name="Terms &amp; Conditions" transform="translate(74.764 127)" fill="#8ADB20"
          font-size="10" font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-49.93" y="0">Terms &amp; Conditions</tspan>
        </text>
        <text id="Billing_info" data-name="Billing info" transform="translate(188 127)" fill="#8ADB20" font-size="10"
          font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-27.785" y="0">Billing info</tspan>
        </text>
        <text id="Payment_details" data-name="Payment details" transform="translate(300.518 127)" fill="#8ADB20"
          font-size="10" font-family="Montserrat-SemiBold, Montserrat" font-weight="600">
          <tspan x="-41.92" y="0">Payment details</tspan>
        </text>
      </g>
    </svg>
  </div>
</ion-header>

<ion-content>
  <div class="first-step" *ngIf="stepIndex==1 && !loading">
    <ngx-extended-pdf-viewer [base64Src]="pdfLink" 
    [useBrowserLocale]="true" [showSidebarButton]="false" 
    [showFindButton]="false"
    [showSecondaryToolbarButton]="false"></ngx-extended-pdf-viewer>
  </div>
  <div class="second-step" *ngIf="stepIndex==2 && !loading">
    <form [formGroup]="newContractForm" *ngIf="newContractForm && !loading">
      <div class="input-box-md">
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Contact First Name" formControlName="firstName" required>
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Contact Last Name" formControlName="lastName" required>
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="email" placeholder="Email" formControlName="email" required>
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="tel" placeholder="Mobile Phone" formControlName="phone" [textMask]="{ mask: Constants.masks.phone }" required>
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="tel" placeholder="Direct Office Phone" formControlName="phone2" [textMask]="{ mask: Constants.masks.phone }">
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Address" formControlName="address1" required>
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Apt, Suite" formControlName="address2">
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Zip Code" formControlName="zipCode" (keyup)="getZipCode()" maxlength="5" required>
        </mat-form-field>
        <ion-label color="info" *ngIf="zipCodeLoading">Validating zip code...</ion-label>
        <ion-spinner *ngIf="zipCodeLoading"></ion-spinner>
        <mat-form-field class="full-width" *ngIf="!zipCodeLoading && citiesInZipCode">
          <mat-select formControlName="city" placeholder="City" required>
            <mat-option *ngFor="let city of citiesInZipCode" [value]="city">
              {{ city }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="full-width" *ngIf="!zipCodeLoading && stateID.value && stateID.value != 'null'">
          <input matInput type="text" placeholder="State" formControlName="stateShort">
        </mat-form-field>
        <ion-row>
          <span>Billing Address</span>
        </ion-row>
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Address" formControlName="billingAddress1" required>
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Apt, Suite" formControlName="billingAddress2">
        </mat-form-field>
        <mat-form-field class="full-width">
          <input matInput type="text" placeholder="Zip Code" formControlName="billingZipCode" (keyup)="getBillingZipCode()" maxlength="5" required>
        </mat-form-field>
        <ion-label color="info" *ngIf="billingZipCodeLoading">Validating zip code...</ion-label>
        <ion-spinner *ngIf="billingZipCodeLoading"></ion-spinner>
        <mat-form-field class="full-width" *ngIf="!billingZipCodeLoading && billingCitiesInZipCode">
          <mat-select formControlName="billingCity" placeholder="City" required>
            <mat-option *ngFor="let city of billingCitiesInZipCode" [value]="city">
              {{ city }}
            </mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field class="full-width" *ngIf="!billingZipCodeLoading && billingStateID.value && billingStateID.value != 'null'">
          <input matInput type="text" placeholder="State" formControlName="billingStateShort">
        </mat-form-field>
      </div>

      <ng-container *ngFor="let location of contract.locations;let i = index">
        <div class="card-wrap">
          <ion-card>
            <ion-row>
              <ion-col no-padding col-12>
                <ion-row class="go-arrow-configure">
                  <div>
                    <span>Service Address ({{ i + 1 }})</span><br>
                    <span class="des">{{ location.address1 }} {{ location.address2 }}</span><br>
                    <span class="des">{{ location.city }}, {{ location.state?.stateLong }} {{ location.zipCode }}</span><br>
                    <span class="des">Utility Acct #: {{ location.utilityAccountNum }}</span>
                  </div>
                </ion-row>
              </ion-col>
            </ion-row>
          </ion-card>
        </div>
      </ng-container>

      <ion-item text-wrap *ngIf="startNewContractValidation && !firstName.valid && (firstName.dirty || firstName.touched)">
        <ion-label color="danger">Please enter your first name.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !lastName.valid && (lastName.dirty || lastName.touched)">
        <ion-label color="danger">Please enter your last name.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !address1.valid && (address1.dirty || address1.touched)">
        <ion-label color="danger">Please enter your address.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !city.valid && (city.dirty || city.touched)">
        <ion-label color="danger">Please choose a city.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !zipCode.valid && (zipCode.dirty || zipCode.touched)">
        <ion-label color="danger">Please enter a zip code.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !billingAddress1.valid && (billingAddress1.dirty || billingAddress1.touched)">
        <ion-label color="danger">Please enter your billing address.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !billingCity.valid && (billingCity.dirty || billingCity.touched)">
        <ion-label color="danger">Please choose a billing city.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !billingZipCode.valid && (billingZipCode.dirty || billingZipCode.touched)">
        <ion-label color="danger">Please enter a billing zip code.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !email.valid && (email.dirty || email.touched)">
        <ion-label color="danger">Please enter your email.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !phone.valid && (phone.dirty || phone.touched)">
        <ion-label color="danger">Please enter a valid phone number.</ion-label>
      </ion-item>

      <ion-item text-wrap *ngIf="startNewContractValidation && !phone2.valid && (phone2.dirty || phone2.touched)">
        <ion-label color="danger">Please enter a valid company phone number.</ion-label>
      </ion-item>
    </form>
  </div>
  <div class="third-step" *ngIf="stepIndex==3 && !loading">
    <ion-row class="third-detail-wrap">
      <ion-row class="detail">
        <ion-col no-padding col-6>
          <span class="detail-title" no-padding>Effective Date</span><br>
          <span class="detail-des" no-padding>{{ contract?.effectiveDate | date:'shortDate' }}</span><br><br>
          <span class="detail-title" no-padding>Utility</span><br>
          <span class="detail-des" no-padding>{{ contract?.getUtilityAbbreviation() }}</span><br><br>
          <span class="detail-title" no-padding>Rate per kWh</span><br>
          <ion-row class="detail-des" *ngIf="bid">
            <span class="big" no-padding>{{ bid.displayRate }}</span>
          </ion-row>
          <ion-row class="detail-des" *ngIf="!bid && contract">
            <span class="big" no-padding>{{ contract.rate * 100 | currency:'USD':'symbol':'1.2-5' }}</span>
          </ion-row>
        </ion-col>
        <ion-col no-padding col-6>
          <ng-container *ngIf="bid">
            <span class="detail-title" no-padding>Term (Duration)</span><br>
            <span class="detail-des" no-padding>{{ bid.rfqSessionProduct ? bid.rfqSessionProduct.term : bid.term }} months</span><br><br>
            <span class="detail-title" no-padding>Supplier</span><br>
            <span class="detail-des" no-padding>{{ bid.supplier?.name }}</span><br><br>
          </ng-container>
          <ng-container *ngIf="!bid && contract">
            <span class="detail-title" no-padding>Term (Duration)</span><br>
            <span class="detail-des" no-padding *ngIf="!bid && contract">{{ contract.term }} months</span><br><br>
            <span class="detail-title" no-padding>Supplier</span><br>
            <span class="detail-des" no-padding *ngIf="!bid && contract">{{ contract.supplier?.name }}</span><br><br>
          </ng-container>
          <span class="detail-title" no-padding>Projected Yearly Spending (Est.)</span><br>
          <ion-row class="detail-des">
            <span class="big" no-padding>${{ getEstAnnualSpendMainPart() }}</span>
            <div class="top">{{ getEstAnnualSpendDecimalPart() }}</div>
          </ion-row>
        </ion-col>
      </ion-row>
    </ion-row>
    <ion-row class="go-arrow" (click)="goBillingInfo()">
      <ion-row class="go-row">
        <ion-col no-padding col-8>
          <span class="top-des" *ngIf="card">{{ card.brand }}</span><br>
          <span class="visa-num" *ngIf="card">●●●● ●●●● ●●●● {{ card.last4 }}</span>
          <span class="visa-num" *ngIf="!card">No card on file yet!  Add a payment method by clicking here.</span>
        </ion-col>
        <ion-col no-padding col-4 class="card-arrow">
          <ion-row class="-icon">
            <fa-icon [icon]="getCardIcon(card)"></fa-icon>
            <ion-icon name="ios-arrow-forward"></ion-icon>
          </ion-row>
        </ion-col>
      </ion-row>
    </ion-row>

    <div class="charges">
      <div>Service Fees ............................................................... <span>6.79¢</span></div>
      <div>Surcharges ................................................................. <span>6.79¢</span></div>
      <div>Fees ................................................................................ <span>6.79¢</span></div>
      <div>Power Kiosk Fee ..................................................... <span>6.79¢</span></div>
      <div>Monthly Fees ............................................................ <span>6.79¢</span></div>
      <div>Contract Fees ........................................................... <span>6.79¢</span></div>
      <div>Contract Term Fees ............................................... <span>6.79¢</span></div>
      <strong>
        <div>Order Total (with Pricing Details) .............. <span>6.79¢</span></div>
      </strong>
    </div>

    <ion-row *ngIf="newContractErrorMessage" text-wrap>
      <ion-col col-12>
        <ion-label color="danger">{{ newContractErrorMessage }}</ion-label>
      </ion-col>
    </ion-row>

    <ion-item text-wrap *ngIf="startNewContractValidation && !card">
      <ion-label color="danger">Please add a payment method above.</ion-label>
    </ion-item>
  </div>
</ion-content>
<ion-footer>
  <ng-container *ngIf="stepIndex === 1">
    <form [formGroup]="step1NewContractForm" *ngIf="step1NewContractForm">
      <ion-item text-wrap *ngIf="startStep1NewContractValidation && !isTosAccepted.valid && (isTosAccepted.dirty || isTosAccepted.touched)">
        <ion-label color="danger">Please accept the terms and conditions to continue.</ion-label>
      </ion-item>

      <ion-row class="go-arrow-configure">
        <ion-toggle formControlName="isTosAccepted"></ion-toggle>
        <span>Agree with Terms & Conditions</span>
      </ion-row>
      <ion-row>
        <div class="step-btn full-width">
          <button class="normal-button" ion-button color=secondary (click)="next()">Next step</button>
        </div>
      </ion-row>
    </form>
  </ng-container>
  <ng-container *ngIf="stepIndex === 2">
    <ion-row class="step-btn-wrapper">
      <ion-col col-6>
        <div class="step-btn">
          <button class="normal-button" ion-button color=secondary (click)="previous()">Previous step</button>
        </div>
      </ion-col>

      <ion-col col-6>
        <div class="step-btn">
          <button class="normal-button" ion-button color=secondary (click)="next()">Next step</button>
        </div>
      </ion-col>
    </ion-row>
  </ng-container>
  <ng-container *ngIf="stepIndex === 3">
    <ion-row class="step-btn-wrapper">
      <ion-col col-6>
        <div class="step-btn">
          <button class="normal-button" ion-button color=secondary (click)="previous()" [disabled]="!createContractEnabled">Previous step</button>
        </div>
      </ion-col>

      <ion-col col-6>
        <div class="step-btn">
          <button class="normal-button" ion-button color=danger (click)="createContract()" [disabled]="!createContractEnabled">{{ createContractText }}</button>
        </div>
      </ion-col>
    </ion-row>
  </ng-container>
</ion-footer>